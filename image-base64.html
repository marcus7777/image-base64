<link rel="import" href="../polymer/polymer.html">
<!--
`<image-base64></image-base64>` resizing and convert images to base64
@demo demo.html
-->

<dom-module id="image-base64">
  <template>
    <canvas id="canvas" hidden width="{{width}}"></canvas>
  </template>
</dom-module>
<script>
  var that, img, ctx
  Polymer({
    is: "image-base64",
    properties: {
      url: {type:String, observer:"load"},
      width: {type: Number,value: 100},
      background: {type: String, value: "#FFF"},
      scalingUp: {value: false},
      base64: {notify: true}
    },
    load: function(url) {
      var that = this
      img = new Image()
      img.setAttribute('crossOrigin', 'anonymous')
      img.onload = function () {
        //TODO steps = Math.ceil(Math.log(sourceWidth / targetWidth) / Math.log(2)) as http://stackoverflow.com/questions/17861447/html5-canvas-drawimage-how-to-apply-antialiasing
        if (img.width > that.$.canvas.width || that.scalingUp) {
          console.log(Math.ceil(Math.log(img.width / that.$.canvas.width ) / Math.log(2)))
          that.$.canvas.height = that.$.canvas.width * (img.height / img.width)
        } else {// to avoid scaling up
          that.$.canvas.height = img.height
          that.$.canvas.width = img.width
        }
        var octx = that.$.canvas.getContext('2d')
        octx.fillStyle = that.background
        octx.fillRect(0, 0, img.width, img.height)
        octx.drawImage(img, 0, 0, that.$.canvas.width, that.$.canvas.height)
        that.base64 = that.$.canvas.toDataURL("image/jpeg")
      }
      img.src = url
    }
  })
</script>

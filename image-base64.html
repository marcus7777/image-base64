<link rel="import" href="../polymer/polymer.html">
<script src="../pica/dist/pica.js"></script>
<!--
`<image-base64></image-base64>` resizing and convert images to base64
@demo demo.html
-->

<dom-module id="image-base64">
  <template>
    <canvas id="canvas" hidden width="{{_width}}"></canvas>
  </template>
</dom-module>
<script>
  Polymer({
    is: "image-base64",
    properties: {
      url: {type:String, observer:"load"},
      width: {type: Number,value: 100},
      _width: {computed:"getWidth(width)"},
      background: {type: String, value: "#FFF"},
      scalingUp: {value: false},
      base64: {notify: true},
      maxHeight: {type: Number,value: 300},
      maxWidth: {type: Number,value: 300},
      orientation: {value: 1},
      log: {
        type: Boolean,
        value: false
      },
    },
    getWidth: function(width) {
      if (width < 10) {
        console.log("Small is dangerous, I'm upping your value to 10")
        return 10
      } else {
        return width
      }
    },
    load: function(url) {
      if (url) {
        var that = this
        var img2 = new Image()
        var orientation = that.orientation
        var can = document.createElement("canvas")
        var ctx = can.getContext('2d')
        var thisImage = new Image
        thisImage.setAttribute('crossOrigin', 'anonymous')    
        thisImage.onload = function() {
          if (orientation > 4) {
            var width  = can.width  = thisImage.height
            var height = can.height = thisImage.width 
          } else {
            var width  = can.width  = thisImage.width
            var height = can.height = thisImage.height
          }
          if (that.log) {
            console.log("loaded image " + can.width + " by " + can.height )
          }
          ctx.save()
          
          if (orientation !== 1) {
            if (that.log) {
              console.log("translating and rotate orientation:",orientation)
            }
            switch (orientation) {
              case 2: ctx.translate(width, 0);     ctx.scale(-1,1); break
              case 3: ctx.translate(width,height); ctx.rotate(Math.PI); break
              case 4: ctx.translate(0,height);     ctx.scale(1,-1); break
              case 5: ctx.rotate(0.5 * Math.PI);   ctx.scale(1,-1); break
              case 6: ctx.rotate(0.5 * Math.PI);   ctx.translate(0,-height); break
              case 7: ctx.rotate(0.5 * Math.PI);   ctx.translate(width,-height); ctx.scale(-1,1); break
              case 8: ctx.rotate(-0.5 * Math.PI);  ctx.translate(-width,0); break
            }
            that.orientation = 1          
          }
          ctx.drawImage(thisImage,0,0)
          if (that.log) {
            console.log("drawing Image" )
          }
          ctx.restore()
          img2.src = can.toDataURL()
        }
        img2.onload = function () {
          if (img2.width > that.$.canvas.width || that.scalingUp) {
            //moving the image into themaxHeight
            that.$.canvas.height = that.width * (img2.height / img2.width)
          } else {// to avoid scaling up
            that.$.canvas.height = img2.height
            that.$.canvas.width  = img2.width
          }
          console.log("(img2.height / img2.width)", (img2.height / img2.width))
          
          window.pica.resizeCanvas(this, that.$.canvas, {alpha: true},function() {
            that.$.canvas.height = Math.min(that.$.canvas.height, that.maxHeight)
            if (that.$.canvas.height > that.maxHeight || that.$.canvas.width > that.maxWidth) {
              var tempCanvas = document.createElement("canvas")
              var tCtx = tempCanvas.getContext("2d")

              tempCanvas.width  = Math.min(that.$.canvas.width, that.maxWidth)
              if (that.$.canvas.width > that.maxWidth) {
                var moveLeft = (that.$.canvas.width - that.maxWidth) / 2
              } else {
                var moveLeft = 0
              }
 
              tempCanvas.height = Math.min(that.$.canvas.height, that.maxHeight)
              if (that.$.canvas.height > that.maxHeight) {
                var moveUp = (that.$.canvas.height - that.maxHeight) / 2
              } else {
                var moveUp = 0
              }            
          
              tCtx.drawImage(that.$.canvas,0 - moveLeft ,0 - moveUp)
              that.base64 = tempCanvas.toDataURL("image/png")
            } else {
              that.base64 = that.$.canvas.toDataURL("image/png")
            }
          })
        }
        thisImage.src = url
      } else {
        // that.base64 = ""
      }
    }
  })
</script>

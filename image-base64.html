<link rel="import" href="../polymer/polymer.html">
<script src="../pica/dist/pica.js"></script>
<!--
`<image-base64></image-base64>` resizing and convert images to base64
@demo demo.html
-->

<dom-module id="image-base64">
  <template>
    <canvas id="canvas" hidden width="{{_width}}"></canvas>
  </template>
</dom-module>
<script>
  Polymer({
    is: "image-base64",
    properties: {
      url: {type:String, observer:"load"},
      width: {type: Number,value: 100},
      _width: {computed:"getWidth(width)"},
      background: {type: String, value: "#FFF"},
      scalingUp: {value: false},
      base64: {notify: true},
      maxHeight: {value: 300},
      maxWidth: {value: 300},
      orientation: {value: 1},
    },
		getWidth: function(width) {
			if (width < 10) {
			  console.log("Small is dangerous, I'm upping your value to 10")
				return 10
			} else {
				return width
			}
		},
    load: function(url) {
      var that = this
      var img = new Image()
      img.setAttribute('crossOrigin', 'anonymous')
      img.onload = function () {
        if (img.width > that.$.canvas.width || that.scalingUp) {
          //moving the image into themaxHeight
          that.$.canvas.height = that.width * (img.height / img.width)
        } else {// to avoid scaling up
          that.$.canvas.height = img.height
          that.$.canvas.width  = img.width
        }
	      window.pica.resizeCanvas(img, that.$.canvas, {alpha: true},function() {
          // that.$.canvas.height = Math.min(that.$.canvas.height, that.maxHeight)
            if (that.$.canvas.height > that.maxHeight || that.$.canvas.width > that.maxWidth) {
              var tempCanvas = document.createElement("canvas")
              var tCtx = tempCanvas.getContext("2d")

              tempCanvas.width  = Math.min(that.$.canvas.width, that.maxWidth)
              if (that.$.canvas.width > that.maxWidth) {
                var moveLeft = (that.$.canvas.width - that.maxWidth) / 2
              } else {
                var moveLeft = 0
              }
            
              tempCanvas.height = Math.min(that.$.canvas.height, that.maxHeight)
              if (that.$.canvas.height > that.maxHeight) {
                var moveUp = (that.$.canvas.height - that.maxHeight) / 2
              } else {
                var moveUp = 0
              }
            
              tCtx.drawImage(that.$.canvas,0 - moveLeft ,0 - moveUp)
              switch(that.orientation){
                case 2:
                  // horizontal flip
                  tCtx.translate(canvas.width, 0)
                  tCtx.scale(-1, 1)
                  break
                case 3:
                  // 180° rotate left
                  tCtx.translate(canvas.width, canvas.height)
                  tCtx.rotate(Math.PI)
                  break
                case 4:
                  // vertical flip
                  tCtx.translate(0, canvas.height)
                  tCtx.scale(1, -1)
                  break
                case 5:
                  // vertical flip + 90 rotate right
                  tCtx.rotate(0.5 * Math.PI)
                  tCtx.scale(1, -1)
                  break;
                case 6:
                  // 90° rotate right
                  tCtx.rotate(0.5 * Math.PI)
                  tCtx.translate(0, -canvas.height)
                  break
                case 7:
                  // horizontal flip + 90 rotate right
                  tCtx.rotate(0.5 * Math.PI)
                  tCtx.translate(canvas.width, -canvas.height)
                  tCtx.scale(-1, 1)
                  break
                case 8:
                  // 90° rotate left
                  tCtx.rotate(-0.5 * Math.PI)
                  tCtx.translate(-canvas.width, 0)
                  break
              }
              that.base64 = tempCanvas.toDataURL("image/png")
            } else {
              that.base64 = that.$.canvas.toDataURL("image/png")
            }
          
	      })
      }
      img.src = url
    }
  })
</script>
